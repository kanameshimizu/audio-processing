---
import { segmentsToSrt } from "../lib/srt";
---
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenAI Audio Tools</title>
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }
      
      hgroup {
        text-align: center;
        margin-bottom: 3rem;
      }
      
      hgroup h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2.5rem;
        background: linear-gradient(45deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      hgroup p {
        margin: 0;
        color: #666;
        font-size: 1.1rem;
      }
      
      .tool-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
      }
      
      .tool-section:last-child {
        margin-bottom: 0;
      }
      
      h2 {
        margin: 0 0 1.5rem 0;
        color: #333;
        font-size: 1.5rem;
      }
      
      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
      }
      
      input, select, textarea, button {
        padding: 0.75rem;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s ease;
      }
      
      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      textarea {
        min-height: 120px;
        resize: vertical;
        font-family: inherit;
      }
      
      button {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      }
      
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      #transcribeResult {
        background: white;
        border: 2px solid #e1e5e9;
        min-height: 150px;
        margin-bottom: 1rem;
      }
      
      #audioPlayer {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        border: 2px solid #e1e5e9;
      }
      
      audio {
        width: 100%;
        margin-bottom: 1rem;
      }
      
      pre {
        background: #2d3748;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 0.875rem;
      }
      
      @media (max-width: 768px) {
        body {
          padding: 1rem;
        }
        
        .container {
          padding: 1.5rem;
        }
        
        hgroup h1 {
          font-size: 2rem;
        }
        
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <hgroup>
        <h1>OpenAI Audio Tools</h1>
        <p>éŸ³å£°ãƒ»å‹•ç”»ã®æ–‡å­—èµ·ã“ã—ã¨ãƒ†ã‚­ã‚¹ãƒˆã®éŸ³å£°å¤‰æ›</p>
      </hgroup>
      
      <section class="tool-section">
        <h2>ğŸµ éŸ³å£°ãƒ»å‹•ç”» â†’ ãƒ†ã‚­ã‚¹ãƒˆï¼ˆWhisperï¼‰</h2>
        <form id="transcribeForm" onsubmit="return false;">
          <input type="file" name="file" accept="audio/*,video/*" required />
          <select name="mode">
            <option value="transcribe">æ–‡å­—èµ·ã“ã—ï¼ˆåŸæ–‡ï¼‰</option>
            <option value="translate_en">è‹±èªã¸ç¿»è¨³ï¼ˆWhisperï¼‰</option>
          </select>
          <select name="timestamps">
            <option value="both">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: word+segment</option>
            <option value="segment">segment ã®ã¿</option>
            <option value="word">word ã®ã¿</option>
            <option value="none">ãªã—</option>
          </select>
          <button id="transcribeBtn" type="button">æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ</button>
        </form>
        <textarea id="transcribeResult" placeholder="æ–‡å­—èµ·ã“ã—çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
        <pre id="transcribeJson" style="display: none;"></pre>
        <button id="downloadSrt" disabled>SRT ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      </section>

      <section class="tool-section">
        <h2>ğŸ”Š ãƒ†ã‚­ã‚¹ãƒˆ â†’ éŸ³å£°ï¼ˆTTSï¼‰</h2>
        <form id="ttsForm" onsubmit="return false;">
          <textarea name="text" placeholder="éŸ³å£°ã«ã—ãŸã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...ï¼ˆé•·æ–‡ã®å ´åˆã¯è‡ªå‹•ã§åˆ†å‰²ã•ã‚Œã¾ã™ï¼‰" required></textarea>
          <div id="textStats" style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;"></div>
          <div class="form-row">
            <select name="voice">
              <option value="alloy">Alloyï¼ˆä¸­æ€§çš„ï¼‰</option>
              <option value="echo">Echoï¼ˆç”·æ€§çš„ï¼‰</option>
              <option value="fable">Fableï¼ˆè‹±å›½ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼‰</option>
              <option value="onyx">Onyxï¼ˆæ·±ã„ç”·æ€§å£°ï¼‰</option>
              <option value="nova">Novaï¼ˆè‹¥ã„å¥³æ€§å£°ï¼‰</option>
              <option value="shimmer">Shimmerï¼ˆå¥³æ€§çš„ï¼‰</option>
            </select>
            <select name="model">
              <option value="tts-1">æ¨™æº–å“è³ªï¼ˆé«˜é€Ÿï¼‰</option>
              <option value="tts-1-hd">é«˜å“è³ªï¼ˆä½é€Ÿï¼‰</option>
            </select>
            <select name="format">
              <option value="mp3">MP3</option>
              <option value="opus">Opus</option>
              <option value="aac">AAC</option>
              <option value="flac">FLAC</option>
            </select>
          </div>
          <button id="ttsBtn" type="button">éŸ³å£°ç”Ÿæˆ</button>
        </form>
        <div id="ttsProgress" style="display: none;">
          <div style="background: #e1e5e9; border-radius: 4px; height: 8px; margin: 1rem 0;">
            <div id="progressBar" style="background: linear-gradient(45deg, #667eea, #764ba2); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s ease;"></div>
          </div>
          <div id="progressText" style="text-align: center; font-size: 0.9rem; color: #666;"></div>
        </div>
        <div id="audioPlayer" style="display: none;">
          <audio controls></audio>
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button id="downloadAudio">éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button id="downloadAll" style="display: none;">å…¨éŸ³å£°ã‚’ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>
      </section>
    </main>
    <script>
      // Whisperé–¢é€£ã®è¦ç´ 
      const transcribeForm = document.getElementById('transcribeForm') as HTMLFormElement;
      const transcribeBtn = document.getElementById('transcribeBtn') as HTMLButtonElement;
      const transcribeResult = document.getElementById('transcribeResult') as HTMLTextAreaElement;
      const transcribeJson = document.getElementById('transcribeJson') as HTMLPreElement;
      const downloadSrtBtn = document.getElementById('downloadSrt') as HTMLButtonElement;
      
      // TTSé–¢é€£ã®è¦ç´ 
      const ttsForm = document.getElementById('ttsForm') as HTMLFormElement;
      const ttsBtn = document.getElementById('ttsBtn') as HTMLButtonElement;
      const audioPlayer = document.getElementById('audioPlayer') as HTMLDivElement;
      const downloadAudioBtn = document.getElementById('downloadAudio') as HTMLButtonElement;
      const downloadAllBtn = document.getElementById('downloadAll') as HTMLButtonElement;
      const textStats = document.getElementById('textStats') as HTMLDivElement;
      const ttsProgress = document.getElementById('ttsProgress') as HTMLDivElement;
      const progressBar = document.getElementById('progressBar') as HTMLDivElement;
      const progressText = document.getElementById('progressText') as HTMLDivElement;
      
      let currentAudioBlob: Blob | null = null;
      let currentTranscriptionData: any = null;
      let generatedAudioFiles: Blob[] = [];
      
      // æ–‡å­—èµ·ã“ã—æ©Ÿèƒ½
      async function runTranscribe() {
        if (!transcribeForm || !transcribeResult || !transcribeJson) return;
        
        transcribeBtn.textContent = 'å‡¦ç†ä¸­...';
        transcribeBtn.disabled = true;
        
        try {
          const fd = new FormData(transcribeForm);
          const res = await fetch('/api/transcribe', { method: 'POST', body: fd });
          const data = await res.json();
          
          transcribeResult.value = data.text || '';
          transcribeJson.textContent = JSON.stringify(data, null, 2);
          currentTranscriptionData = data;
          
          // SRTãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
          if (data.segments && data.segments.length > 0) {
            downloadSrtBtn.disabled = false;
          }
        } catch (error) {
          console.error('Transcription error:', error);
          transcribeResult.value = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error;
        } finally {
          transcribeBtn.textContent = 'æ–‡å­—èµ·ã“ã—å®Ÿè¡Œ';
          transcribeBtn.disabled = false;
        }
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²æ©Ÿèƒ½
      function splitText(text: string, maxLength: number = 4000): string[] {
        if (text.length <= maxLength) return [text];
        
        const chunks: string[] = [];
        const sentences = text.split(/[ã€‚ï¼ï¼Ÿ\n]/);
        let currentChunk = '';
        
        for (const sentence of sentences) {
          const testChunk = currentChunk + sentence + 'ã€‚';
          if (testChunk.length > maxLength && currentChunk.length > 0) {
            chunks.push(currentChunk.trim());
            currentChunk = sentence + 'ã€‚';
          } else {
            currentChunk = testChunk;
          }
        }
        
        if (currentChunk.trim()) {
          chunks.push(currentChunk.trim());
        }
        
        return chunks.filter(chunk => chunk.length > 0);
      }
      
      // æ–‡å­—æ•°çµ±è¨ˆæ›´æ–°
      function updateTextStats() {
        const textarea = ttsForm.querySelector('textarea[name="text"]') as HTMLTextAreaElement;
        const text = textarea.value;
        const chunks = splitText(text);
        
        if (text.length === 0) {
          textStats.textContent = '';
          return;
        }
        
        textStats.textContent = `æ–‡å­—æ•°: ${text.length} | åˆ†å‰²æ•°: ${chunks.length}ãƒãƒ£ãƒ³ã‚¯`;
        if (chunks.length > 1) {
          textStats.textContent += ` | æ¨å®šæ™‚é–“: ${chunks.length * 3}ç§’`;
        }
      }
      
      // TTSæ©Ÿèƒ½ï¼ˆé•·æ–‡å¯¾å¿œï¼‰
      async function runTTS() {
        if (!ttsForm) return;
        
        const textarea = ttsForm.querySelector('textarea[name="text"]') as HTMLTextAreaElement;
        const text = textarea.value.trim();
        
        if (!text) {
          alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        const chunks = splitText(text);
        generatedAudioFiles = [];
        
        ttsBtn.textContent = 'éŸ³å£°ç”Ÿæˆä¸­...';
        ttsBtn.disabled = true;
        ttsProgress.style.display = 'block';
        audioPlayer.style.display = 'none';
        
        try {
          for (let i = 0; i < chunks.length; i++) {
            const progress = ((i + 1) / chunks.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${i + 1} / ${chunks.length} ãƒãƒ£ãƒ³ã‚¯ã‚’å‡¦ç†ä¸­...`;
            
            const fd = new FormData();
            fd.append('text', chunks[i]);
            fd.append('voice', (ttsForm.querySelector('select[name="voice"]') as HTMLSelectElement).value);
            fd.append('model', (ttsForm.querySelector('select[name="model"]') as HTMLSelectElement).value);
            fd.append('format', (ttsForm.querySelector('select[name="format"]') as HTMLSelectElement).value);
            
            const res = await fetch('/api/text-to-speech', { method: 'POST', body: fd });
            
            if (!res.ok) {
              const errorData = await res.json();
              throw new Error(errorData.error || 'TTS API error');
            }
            
            const audioBlob = await res.blob();
            generatedAudioFiles.push(audioBlob);
            
            // å°‘ã—å¾…æ©Ÿï¼ˆAPIåˆ¶é™å¯¾ç­–ï¼‰
            if (i < chunks.length - 1) {
              await new Promise(resolve => setTimeout(resolve, 500));
            }
          }
          
          // æœ€åˆã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          currentAudioBlob = generatedAudioFiles[0];
          const audioElement = audioPlayer.querySelector('audio') as HTMLAudioElement;
          audioElement.src = URL.createObjectURL(currentAudioBlob);
          
          audioPlayer.style.display = 'block';
          ttsProgress.style.display = 'none';
          
          // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          if (generatedAudioFiles.length > 1) {
            downloadAllBtn.style.display = 'inline-block';
          }
          
        } catch (error) {
          console.error('TTS error:', error);
          alert('éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error);
          ttsProgress.style.display = 'none';
        } finally {
          ttsBtn.textContent = 'éŸ³å£°ç”Ÿæˆ';
          ttsBtn.disabled = false;
        }
      }
      
      // SRTãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
      function downloadSRT() {
        if (!currentTranscriptionData?.segments) return;
        
        const srtContent = segmentsToSrt(currentTranscriptionData.segments);
        const blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'subtitles.srt';
        a.click();
        
        URL.revokeObjectURL(url);
      }
      
      // éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
      function downloadAudio() {
        if (!currentAudioBlob) return;
        
        const url = URL.createObjectURL(currentAudioBlob);
        const a = document.createElement('a');
        a.href = url;
        
        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«åŸºã¥ã„ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
        const formatSelect = ttsForm.querySelector('select[name="format"]') as HTMLSelectElement;
        const format = formatSelect.value;
        a.download = `speech.${format}`;
        a.click();
        
        URL.revokeObjectURL(url);
      }
      
      // SRTå¤‰æ›é–¢æ•°ï¼ˆlib/srt.tsã‹ã‚‰ç§»æ¤ï¼‰
      function toSrtTime(sec: number): string {
        const h = Math.floor(sec / 3600).toString().padStart(2, "0");
        const m = Math.floor((sec % 3600) / 60).toString().padStart(2, "0");
        const s = Math.floor(sec % 60).toString().padStart(2, "0");
        const ms = Math.floor((sec % 1) * 1000).toString().padStart(3, "0");
        return `${h}:${m}:${s},${ms}`;
      }
      
      function segmentsToSrt(segments: any[]): string {
        return segments
          .map((seg, i) => {
            const idx = (i + 1).toString();
            const period = `${toSrtTime(seg.start)} --> ${toSrtTime(seg.end)}`;
            const text = (seg.text || "").trim();
            return `${idx}\n${period}\n${text}\n`;
          })
          .join("\n");
      }
      
      // ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ï¼ˆè¤‡æ•°éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
      async function downloadAllAudio() {
        if (generatedAudioFiles.length === 0) return;
        
        // JSZipãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ãŒã€ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã¨ã—ã¦å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        for (let i = 0; i < generatedAudioFiles.length; i++) {
          const url = URL.createObjectURL(generatedAudioFiles[i]);
          const a = document.createElement('a');
          a.href = url;
          
          const formatSelect = ttsForm.querySelector('select[name="format"]') as HTMLSelectElement;
          const format = formatSelect.value;
          a.download = `speech_part_${i + 1}.${format}`;
          a.click();
          
          URL.revokeObjectURL(url);
          
          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–“éš”ã‚’ç©ºã‘ã‚‹
          if (i < generatedAudioFiles.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        }
      }
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      transcribeBtn?.addEventListener('click', runTranscribe);
      ttsBtn?.addEventListener('click', runTTS);
      downloadSrtBtn?.addEventListener('click', downloadSRT);
      downloadAudioBtn?.addEventListener('click', downloadAudio);
      downloadAllBtn?.addEventListener('click', downloadAllAudio);
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å…¥åŠ›ç›£è¦–
      const textArea = ttsForm?.querySelector('textarea[name="text"]') as HTMLTextAreaElement;
      textArea?.addEventListener('input', updateTextStats);
    </script>
  </body>
</html>